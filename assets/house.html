<html>
  <head>
    <style> svg {position: absolute;}</style>
    <style>
      body {
        overscroll-behavior: contain;
      }
      svg text {
        -webkit-user-select: none;
           -moz-user-select: none;
            -ms-user-select: none;
                user-select: none;
                font-size: 25px;
      }
      .thermo {
        overscroll-behavior: contain;
        touch-action: none;
      }
      .thermo g {
        touch-action: none;
      }
      .thermo path {
        touch-action: none;
      }
      .thermo text {
        touch-action: none;
      }
      .room rect {
        stroke: black;
        stroke-width: 2;
      }
      line { stroke-width: 1; stroke: black}
      .room text { font: normal 13px sans-serif; pointer-events: none;}
    </style>
  </head>
  <body style="background-color:white">
    <div id="header">
      <p style="font-size:3em;margin:0">Refuge Home Automation</p>
      <p style="font-size:1em">Units: <a id="unittoggle" href="#">Celcius</a></p>
      <p><a id="edittoggle" href="#">Edit Mode</a></p>
      <p id="debugger"></p>
    </div>
    <div id="interaction">
    <!--  Floor 1-->
    <svg id="maincanvas" height=600 width=600 viewBox="0 0 1200 1200">
      <defs>
        <linearGradient id="hotGrad" x1="0" x2="0.7" y1="0" y2="1.1">
          <stop offset="20%" stop-color="red" stop-opacity="1.0"></stop>
          <stop offset="80%" stop-color="green" stop-opacity="1.0"></stop>
        </linearGradient>
        <linearGradient id="coldGrad" x1="0.7" x2="0" y1="0" y2="0.9">
          <stop offset="20%" stop-color="green" stop-opacity="1.0"></stop>
          <stop offset="80%" stop-color="blue" stop-opacity="1"></stop>
        </linearGradient>
        <linearGradient id="fire" x1="0" x2="0" y1="1" y2="0">
          <stop offset="0%" stop-color="darkred" stop-opacity="1.0"></stop>
          <stop offset="50%" stop-color="orange" stop-opacity="0.9"></stop>
          <stop offset="100%" stop-color="yellow" stop-opacity="0.8"></stop>
        </linearGradient>
      </defs>
      <g id="floor1">
      <g transform="translate(50,50)" fill="transparent">
        <g class="room" id="garage">
          <rect height=350 width=200></rect>
          <text fill="black" x="50" y="50">Garage</text>
        </g>
        <g transform="translate(200,0)" class="room" id="liv">
          <rect height=150 width=200></rect>
          <text fill="black" x="50" y="50">Living</text>
        </g>
        <g transform="translate(400,0)" class="room" id="din">
          <rect height=150 width=150></rect>
          <text fill="black" x="50" y="50">Dining</text>
        </g>
        <g transform="translate(400, 150)" class="room" id="kitch">
          <rect height=200 width=150></rect>
          <text fill="black" x="50" y="50">Kitchen</text>
        </g>
        <g transform="translate(200, 300)" class="room">
          <rect height=50 width=200></rect>
          <text fill="black" x="30" y="30">Hallway</text>
        </g>
        <g transform="translate(200, 350)" class="room" id="mb">
          <rect height=150 width=200></rect>
          <text fill="black" x="30" y="30">Master Bedroom</text>
        </g>
        <g transform="translate(200, 150)" class="room">
          <rect height=150 width=100></rect>
          <text fill="black" x="20" y="20">Laundry</text>
        </g>
        <g transform="translate(300, 150)" class="room">
          <rect x=50 height=100 width=50></rect>

          <line x1="0" y1="10" x2="100" y2="10"></line>
          <line x1="0" y1="20" x2="100" y2="20"></line>
          <line x1="0" y1="30" x2="100" y2="30"></line>
          <line x1="0" y1="40" x2="100" y2="40"></line>
          <line x1="0" y1="50" x2="100" y2="50"></line>
          <line x1="0" y1="60" x2="100" y2="60"></line>
          <line x1="0" y1="70" x2="100" y2="70"></line>
          <line x1="0" y1="80" x2="100" y2="80"></line>
          <line x1="0" y1="90" x2="100" y2="90"></line>

          <rect height=100 width=50></rect>
          <text fill="black" x="20" y="120">Stairs</text>
        </g>
      </g>
    </g>
    <!--  Floor 2-->
    <g id="floor2" transform="translate(650,0)">
      <g transform="translate(50,50)" fill="transparent">
        <g class="room" id="fam">
          <rect height=150 width=250></rect>
          <text fill="black" x="30" y="50">Family</text>
        </g>
        <g transform="translate(250,0)" class="room">
          <rect height=150 width=100></rect>
          <text fill="black" x="30" y="50">Office</text>
        </g>
        <g transform="translate(250, 150)" class="room">
          <rect height=200 width=100></rect>
          <text fill="black" x="30" y="50">Bedroom</text>
        </g>
        <g transform="translate(200, 150)" class="room">
          <rect height=200 width=50></rect>
        </g>
        <g transform="translate(0, 300)" class="room">
          <rect height=50 width=200></rect>
          <text fill="black" x="130" y="30">Hallway</text>
        </g>
        <g transform="translate(0, 350)" class="room">
          <rect height=150 width=200></rect>
          <text fill="black" x="30" y="30">Kids Bedroom</text>
        </g>
        <g transform="translate(0, 150)" class="room">
          <rect height=150 width=100></rect>
          <text fill="black" x="20" y="20">Bathroom</text>
        </g>
        <g transform="translate(100, 150)" class="room">
          <rect x=50 height=100 width=50></rect>

          <line x1="0" y1="10" x2="100" y2="10"></line>
          <line x1="0" y1="20" x2="100" y2="20"></line>
          <line x1="0" y1="30" x2="100" y2="30"></line>
          <line x1="0" y1="40" x2="100" y2="40"></line>
          <line x1="0" y1="50" x2="100" y2="50"></line>
          <line x1="0" y1="60" x2="100" y2="60"></line>
          <line x1="0" y1="70" x2="100" y2="70"></line>
          <line x1="0" y1="80" x2="100" y2="80"></line>
          <line x1="0" y1="90" x2="100" y2="90"></line>

          <rect height=100 width=50></rect>
          <text fill="black" x="20" y="120">Stairs</text>
        </g>
      </g>
    </g>
  </svg>
  </div>
    <svg id="controlTemplates" style="display:none">
      <g class="thermo" id="thermoTemplate">
        <title>unnamed</title>
        <g class="controls" transform="translate(20, -80)">
          <path d="M 0 50 L 0 0 A 100 100 0 0 1 100 100 L 50 100 A 50 50 0 0 0 0 50" fill="url('#hotGrad')"></path>
          <path d="M 50 100 L 100 100 A 100 100 0 0 1 0 200 L 0 150 A 50 50 0 0 0 50 100" fill="url('#coldGrad')"></path>
          <path d="" stroke="gray" fill="gray" stroke-width="1px"></path>
          <path d="" stroke="gray" fill="gray" stroke-width="1px"></path>
          <path d="" stroke="gray" stroke-width="2px"></path>
          <path d="M 50 100 L 100 100 A 100 100 0 0 1 0 200 L 0 150 A 50 50 0 0 0 50 100" fill="black" fill-opacity="0.3"></path>
          <text fill="black" style="font: normal 20px sans-serif;" x=0 y=0>T</text>
          <text fill="black" style="font: normal 20px sans-serif;" x=0 y=0>T</text>
        </g>
        <circle cx=20 cy=20 r=40 style="stroke:gray;fill:white"></circle>
        <text fill="black" stroke="white" style="font: normal 36px sans-serif;" x=-2 y=32 class="temp">70</text>
      </g>
      <g class="switch" id="switchTemplate"><title>unnamed</title>
        <rect height=50 width=50 stroke="black" fill="white"></rect>
        <path transform="scale(0.037) translate(100, 100)" fill="url('#fire')" style="" d="M310.591 1200C64.731 1061.434 0 930.279 37.008 751.149c27.321-132.272 116.782-239.886 125.36-371.904 38.215 69.544 54.182 119.692 58.453 192.364C342.364 422.695 422.682 216.546 427.438 0c0 0 316.575 186.01 337.348 466.98 27.253-57.913 40.972-149.891 13.718-209.504 81.758 59.615 560.293 588.838-64.818 942.524 117.528-228.838 30.32-537.612-173.738-680.218 13.627 61.32-10.266 290.02-100.543 390.515 25.014-167.916-23.8-238.919-23.8-238.919s-16.754 94.055-81.758 189.067C274.488 947.206 233.358 1039.29 310.591 1200z"></path>
      </g>
      <g class="portal" id="portalTemplate"><title>unnamed</title><rect height=50 width=50 fill="white" stroke="black"></rect><g name="garageOpen" transform="translate(5,5)" fill="red"><path d="M5.5 35.755V17.752l-2.25 1.75L0 14.627 19.502 0l19.503 14.627-3.25 4.876-2.25-1.75v18.002h-3.001V17.752H8.501v18.003h-3z"></path></g>
        <g name="garageOpenHover" transform="translate(5,5)" style="display: none;"><path d="M5.5 35.755V17.752l-2.25 1.75L0 14.627 19.502 0l19.503 14.627-3.25 4.876-2.25-1.75v18.002h-3.001V17.752H8.501v18.003h-3zm14.003-2.752l-6.25-6.25h3.25v-7h6v7h3.25l-6.25 6.25z"></path></g>
        <g name="garageClosed" transform="translate(5,5)" style="display: none;"><path d="M5.5 35.755V17.752l-2.25 1.75L0 14.627 19.502 0l19.503 14.627-3.25 4.876-2.25-1.75v18.002h-3.001V17.752H8.501v18.003h-3zm23.004-12.002H10.501v-4h18.003v4zm0 6.001H10.501v-4h18.003v4zm0 6H10.501v-4h18.003v4z"></path></g>
        <g name="garageClosedHover" transform="translate(5,5)" style="display: none;"><path d="M5.5 35.755V17.752l-2.25 1.75L0 14.627 19.502 0l19.503 14.627-3.25 4.876-2.25-1.75v18.002h-3.001V17.752H8.501v18.003h-3zm14.002-12.25l6.25 6.25h-3.25v6h-6v-6h-3.25l6.25-6.25zm-9.001.248v-4h19.003v4h-7.001l-3-3-3.001 3h-6.001zm0 12.002v-4h4v4h-4zm19.003-4v4h-5.001v-4h5zm0-2.001h-2l-3.001-4h5v4zm-19.003 0v-4h4l-3 4h-1z"></path></g>
      </g>
    </svg>
    <svg id="icons" height=200 width=1000 style="display:none">
      <g id="cooling" style="pointer-events: none;" transform="scale(0.5)"><path d="M24.236 14.465l2.511-2.51 2.24 2.239-4.75 4.75v4.439l3.912-2.26 1.739-6.488 3.059.82-.92 3.43 4.086-2.36 1.49-5.56 7.647 2.049-2.05 7.647-5.406-1.45-4.252 2.455 3.43.92-.82 3.058-6.488-1.738-3.844 2.219 3.844 2.22 6.488-1.74.82 3.06-3.43.919 4.252 2.454 5.407-1.449 2.049 7.647-7.647 2.05-1.49-5.562-4.085-2.358.919 3.43-3.059.82-1.739-6.491-3.913-2.259v4.44l4.75 4.75-2.239 2.238-2.51-2.51v4.909l3.958 3.958-5.598 5.598-5.598-5.598 4.07-4.07v-4.718l-2.51 2.511-2.24-2.24 4.75-4.75v-4.518l-3.843 2.22-1.74 6.488-3.058-.82.92-3.429-4.252 2.455-1.45 5.407L0 39.137l2.049-7.646 5.56 1.49 4.086-2.359-3.43-.919.82-3.058 6.488 1.738 3.913-2.258-3.913-2.26-6.488 1.74-.82-3.06 3.43-.918-4.085-2.359-5.561 1.49L0 13.111l7.647-2.049 1.449 5.407 4.251 2.455-.919-3.43 3.059-.82 1.738 6.49 3.845 2.219v-4.519l-4.75-4.75 2.239-2.239 2.51 2.51V9.669l-4.07-4.071L22.597 0l5.598 5.598-3.959 3.958v4.91zm-3.822-8.923l2.239 2.239 2.24-2.24-2.24-2.238-2.24 2.24zm0 41.166l2.239 2.24 2.24-2.24-2.24-2.239-2.24 2.24zM3.708 17.773l3.058-.82-.82-3.059-3.058.82.82 3.059zm35.651 20.582l3.059-.82-.82-3.059-3.059.82.82 3.059zm0-24.462l-.82 3.059 3.06.82.819-3.06-3.059-.819zM3.708 34.478l-.82 3.058 3.059.82.82-3.059-3.06-.82z"></path></g>
      <g id="heating" style="pointer-events: none;" transform="scale(0.3)"><path d="M22.316,28.8c0-7.037,2.461-13.895,6.932-19.311c0.964-1.169,0.799-2.898-0.37-3.862c-1.168-0.963-2.897-0.799-3.862,0.37   C19.737,12.394,16.83,20.492,16.83,28.8c0,8.381,2.953,16.534,8.315,22.959c4.54,5.439,7.041,12.343,7.041,19.441   c0,7.037-2.462,13.895-6.932,19.31c-0.964,1.169-0.799,2.898,0.37,3.862C26.135,94.794,26.753,95,27.369,95   c0.79,0,1.575-0.34,2.118-0.997c5.279-6.397,8.187-14.495,8.187-22.803c0-8.381-2.953-16.534-8.315-22.959   C24.817,42.803,22.316,35.899,22.316,28.8z"></path><path d="M45.065,28.8c0-7.037,2.462-13.895,6.932-19.311c0.964-1.169,0.799-2.898-0.37-3.862c-1.168-0.963-2.897-0.799-3.862,0.37   c-5.279,6.397-8.187,14.495-8.187,22.803c0,8.381,2.953,16.534,8.315,22.959c4.54,5.439,7.041,12.343,7.041,19.441   c0,7.037-2.461,13.895-6.932,19.31c-0.964,1.169-0.799,2.898,0.37,3.862C48.884,94.794,49.502,95,50.117,95   c0.79,0,1.575-0.34,2.118-0.997c5.279-6.397,8.187-14.495,8.187-22.803c0-8.381-2.953-16.534-8.315-22.959   C47.566,42.803,45.065,35.899,45.065,28.8z"></path><path d="M74.855,48.242c-4.54-5.438-7.041-12.343-7.041-19.441c0-7.037,2.462-13.895,6.932-19.311   c0.964-1.169,0.799-2.898-0.37-3.862c-1.168-0.963-2.897-0.799-3.862,0.37c-5.279,6.397-8.187,14.495-8.187,22.803   c0,8.381,2.953,16.534,8.315,22.959c4.54,5.439,7.041,12.343,7.041,19.441c0,7.037-2.462,13.895-6.932,19.31   c-0.964,1.169-0.799,2.898,0.37,3.862C71.633,94.794,72.251,95,72.866,95c0.79,0,1.575-0.34,2.118-0.997   c5.279-6.397,8.187-14.495,8.187-22.803C83.17,62.819,80.217,54.666,74.855,48.242z"></path></g>
    </svg>
  </body>
  <script>
    var xmlns = "http://www.w3.org/2000/svg";

    var ws;
    var editing = false;

    var floor1 = document.getElementById("floor1");
    var floor2 = document.getElementById("floor2");
    var maincanvas = document.getElementById("maincanvas");
    maincanvas.addEventListener("mousemove", function(e) {
      var svgp = svgPoint(maincanvas, e.clientX, e.clientY)
      // console.log("SVG Point:", svgp);
    });
    var header = document.getElementById("header");
    // Handle window resizing -- allow changing between portrait and landscape.
    var doSize = function() {
      var headerHeight = header.getBoundingClientRect().height;
      if (window.innerWidth < window.innerHeight) {
        var w = window.innerWidth;
        maincanvas.setAttribute("width", w-50);
        maincanvas.setAttribute("height", w*2);
        maincanvas.setAttribute("viewBox", "0 0 600 1200");
        floor2.setAttribute("transform", "translate(0,600)");
      } else {
        var maxHeight = (window.innerHeight-headerHeight);
        var w = window.innerWidth;
        maincanvas.setAttribute("width", w-50);
        maincanvas.setAttribute("height", maxHeight);
        maincanvas.setAttribute("viewBox", "0 0 1200 600");
        floor2.setAttribute("transform", "translate(600, 0)");
      }
    };

    window.addEventListener("resize", doSize)
    doSize();
    var toggle = document.getElementById("unittoggle");
    toggle.addEventListener("click", toggleUnits);

    var units = getUnits();
    if (units == "F") {
        toggle.innerText = "Fahrenheit";
    } else {
        toggle.innerText = "Celcius";
    }

    var editToggle = document.getElementById("edittoggle");
    editToggle.addEventListener("click", function() {
      editing = !editing;
    });


    // Global list of all devices we are rendering.
    var devices = {};

    console.log("Starting websocket...")
    onClose(); // Reconnects the web socket

    // websocket functions
    function onOpen(event) {
      console.log("Socket opened.");
    }

    function onMessage(event) {
      var msg = JSON.parse(event.data);
      console.log("Msg: ", msg);
      if (msg.Thermostat != null) {
        updateThermo(msg);
      }
      if (msg.Switch != null) {
        updateSwitch(msg);
      }
      if (msg.Portal != null) {
        updatePortal(msg);
      }
    }

    function onClose(event) {
      if (event) {
        console.log("Closed event: ", event);
      }
      var timeout = 0;
      if (ws) {
        console.log("Reconnecting...")
        timeout = 1000;
      }
      setTimeout(function(){
        var prot = "wss://"
        if (location.protocol != 'https:') {
          prot = "ws://"
        }
        ws = new WebSocket(prot + location.host + "/stream");
        ws.addEventListener('close', onClose)
        ws.addEventListener('open', onOpen)
        ws.addEventListener('message', onMessage);
      }, timeout)
    }

    function updateThermo(msg) {
      var id = "td" + msg.Name.replace(/\s/g, "");
      var device = devices[id];
      if (device == null || device == undefined)  {
        var itemEle = document.getElementById("thermoTemplate").cloneNode(true);
        itemEle.id = id;
        itemEle.childNodes[1].textContent = msg.Name;
        var thermoControl = null;
        for (var i = 0; i < itemEle.childNodes.length; i++) {
          var ch = itemEle.childNodes[i];
          if (ch.tagName != "g") {
            continue;
          }
          var cl = ch.getAttribute("class");
          if (cl == "controls") {
            thermoControl = ch;
            break;
          }
        }
        thermoControl.id = "tc_"+id;
        thermoControl.style.display = "none";
        thermoControl.style.position = "absolute";

        device = {
          touching: false,
          attached: null,
          name: msg.Name,
          msg: msg,
          thermoControl: thermoControl
        };
        device.msg = msg;
        devices[id] = device;
        if (msg.Pos.RoomID != "") {
          // Attach it to the floor instead of the room.
          var attached = document.getElementById(msg.Pos.RoomID);
          device.attached = attached;
          attached.parentElement.parentElement.appendChild(itemEle);
          itemEle.setAttribute("transform", "translate(" + msg.Pos.X +","+ msg.Pos.Y+") scale(1.25)");
          var atBR = attached.getBoundingClientRect();
          var icon = null;
          var fadeStep = 0;
          var draw = function() {
            if (editing) {
              return;
            }
            if (device.msg.Thermostat.State > 0) {
              if (icon != null) {
                if (fadeStep < 80) {
                  icon.style.opacity = (100-fadeStep)*0.01;
                } else {
                  icon.style.opacity = (fadeStep-60)*0.01;
                }
                fadeStep++;
                if (fadeStep == 160) {
                  fadeStep = 0;
                }
              } else if (device.msg.Thermostat.State == 1) {
                  icon = document.getElementById("cooling").cloneNode(true);
                  icon.id = ""
                  var x = atBR.width/3-40;
                  var y = atBR.height/3-40;
                  icon.setAttribute("stroke", "blue");
                  icon.setAttribute("fill", "blue");
                  icon.setAttribute("transform","translate("+x+","+y+") scale(2)");
                  attached.appendChild(icon);
              } else if (device.msg.Thermostat.State == 3) {
                  icon = document.getElementById("heating").cloneNode(true);
                  icon.id = ""
                  var x = atBR.width/3-50;
                  var y = atBR.height/3-50;
                  icon.setAttribute("stroke", "red");
                  icon.setAttribute("fill", "red");
                  icon.setAttribute("transform","translate("+x+","+y+") scale(1.2)");
                  icon.style.opacity = 1.0;
                  attached.appendChild(icon);
              }
              window.requestAnimationFrame(draw);
              return;
            }
            if (icon != null) {
              icon.remove();
              icon = null;
            }
            drawThermoLines(device.thermoControl, msg.Thermostat.Settings.High, msg.Thermostat.Settings.Low, msg.Thermometer.Temp);
            // If we have no heating/cooling check again in 1 second.
            window.setTimeout(draw, 1000);
          }
          draw();
        } else {
          maincanvas.appendChild(itemEle);
        }

        device.itemEle = itemEle;
        device.thermoControl = thermoControl;
        var contVis = false;

        device.itemEle.childNodes[7].addEventListener("click", function(e) {
          if (editing) {
            return;
          }
          if (contVis) {
            device.thermoControl.style.display = "none";
            contVis = false;
          } else {
            displayThermo(device);
            contVis = true;
          }
          e.preventDefault();
        });
        addEditorControls(device); // Add main body editing listeners
        thermoInteraction(device); // Add thermo controls UI
      }

      device.msg = msg;
      var target = msg.Thermostat.Target;
      if (!device.touching) {
        drawThermoLines(device.thermoControl, msg.Thermostat.Settings.High, msg.Thermostat.Settings.Low, msg.Thermometer.Temp);
      }

      var temp = msg.Thermometer.Temp;
      if (units == "F") {
        target = convertToF(target);
        temp = convertToF(temp);
      }
      // Now update the values for current temp/hum and target.
      // thdiv.childNodes[2].childNodes[1].innerText = thdata.Humidity;
      device.itemEle.childNodes[7].textContent = temp.toFixed(0) + "*";
    }

    function updatePortal(msg) {
      var id = "pd" + msg.Name.replace(/\s/g, "");
      var device = devices[id];
      if (device == null || device == undefined)  {
        var itemEle = document.getElementById("portalTemplate").cloneNode(true);

        itemEle.id = id;
        itemEle.childNodes[0].textContent = msg.Name;
        maincanvas.appendChild(itemEle);

        device = {};
        if (msg.Pos.RoomID != "") {
          var attached = document.getElementById(msg.Pos.RoomID);
          device.attached = attached;
          itemEle.setAttribute("transform", "translate(" + msg.Pos.X + "," + msg.Pos.Y + ") scale(1.25)")
          attached.parentElement.parentElement.appendChild(itemEle);
        }
        device.itemEle = itemEle;
        device.name = msg.Name;
        device.interType = 2;
        device.msg = msg;
        devices[id] = device;
        addEditorControls(device);
        itemEle.addEventListener("click", function(){
          var state = 1;
          if (device.msg.Portal.State == 1) {
            state = 2;
          }
          var msg = JSON.stringify({Name: device.name, Toggle: state})
          ws.send(msg);
          console.log(msg);
        });
        device.setIcon = function() {
          device.itemEle.childNodes[2].style.display = "none";
          device.itemEle.childNodes[4].style.display = "none";
          device.itemEle.childNodes[6].style.display = "none";
          device.itemEle.childNodes[8].style.display = "none";
          if (device.msg.Portal.State != 1) {
            // Open state
            if (device.hovered) {
              device.itemEle.childNodes[4].style.display = "block";
            } else {
              device.itemEle.childNodes[2].style.display = "block";
            }
          } else {
            // Closed State
            if (device.hovered) {
              device.itemEle.childNodes[8].style.display = "block";
            } else {
              device.itemEle.childNodes[6].style.display = "block";
            }
          }
        }
        itemEle.addEventListener("mouseover", function(e) {
          device.hovered = true;
          device.setIcon();
        });
        itemEle.addEventListener("mouseout", function(e) {
          device.hovered = false;
          device.setIcon();
        });
        device.setIcon();
      }
      device.msg = msg;
      device.setIcon();
    }

    function updateSwitch(msg) {
      var id = "sd" + msg.Name.replace(/\s/g, "");
      var device = devices[id];
      if (device == null || device == undefined)  {
        console.log("Couldn't find existing icon for device " + msg.Name + "... Constructing now: ", id, msg);
        var itemEle = document.getElementById("switchTemplate").cloneNode(true);
        itemEle.id = id;
        itemEle.childNodes[0].textContent = msg.Name;
        device = {};
        devices[id] = device;

        if (msg.Pos.RoomID != "") {
          var attached = document.getElementById(msg.Pos.RoomID);
          device.attached = attached;
          itemEle.setAttribute("transform", "translate(" + msg.Pos.X + "," + msg.Pos.Y + ")")
          attached.parentElement.parentElement.appendChild(itemEle);
        }
        device.itemEle = itemEle;
        device.name = msg.Name;
        device.msg = msg;
        addEditorControls(device);
        maincanvas.appendChild(itemEle);
        itemEle.addEventListener("click", function() {
          var on = 1;
          if (device.msg.Switch.On) {
            on = 2
          }
          var msg = JSON.stringify({Name: device.name, Toggle: on})
          ws.send(msg);
          console.log(msg);
        });
      }
      device.msg = msg;
      if (msg.Switch.On) {
        device.itemEle.childNodes[4].setAttribute("fill", "url('#fire')");
      } else {
        device.itemEle.childNodes[4].setAttribute("fill", "black");
      }
    }

    var inter = document.getElementById("interaction");

    function displayThermo(device) {
      device.itemEle.style.backgroundColor = "gray";
      device.thermoControl.style.display = "block";
      // Start the range markers hidden
      device.thermoControl.childNodes[5].style.display = "none";
      device.thermoControl.childNodes[7].style.display = "none";
      var animateAngle = function(step) {
        if (step > 11) {
          device.thermoControl.childNodes[5].style.display = "block";
          device.thermoControl.childNodes[7].style.display = "block";
          return;
        }

        var start = -Math.PI/2;
        var stepA = Math.PI/12;
        var x = Math.cos(start+stepA*(step+1));
        var y = Math.sin(start+stepA*(step+1));
        if (step < 6) {
          device.thermoControl.childNodes[1].setAttribute("d", "M 0 50 L 0 0 A 100 100 0 0 1 " + (x * 100) + " " + (100+(y*100)) + " L " + (x*50) + " " + (100+(y*50)) + " A 50 50 0 0 0 0 50");
        } else {
          device.thermoControl.childNodes[3].setAttribute("d", "M 50 100 L 100 100 A 100 100 0 0 1 " + (x * 100) + " " + (100+(y*100)) + " L " + (x*50) + " " + (100+(y*50)) + " A 50 50 0 0 0 50 100");
        }
        window.requestAnimationFrame(function(){ animateAngle(step+1)});
      }
      device.thermoControl.childNodes[3].setAttribute("d", "");
      animateAngle(0);
    }

    window.addEventListener("touchmove", function(e){
      // console.log("Window touchmove?", e);
    });
    function thermoInteraction(device) {
      // Setup thermostat control UI
      var grabbing = 0;
      var angle = 0;
      var spread = device.msg.Thermostat.Settings.High - device.msg.Thermostat.Settings.Low;
      var mid = (device.msg.Thermostat.Settings.High + device.msg.Thermostat.Settings.Low)/2;
      var ibr = device.itemEle.getBoundingClientRect();
      var isp = svgPoint(maincanvas, ibr.x, ibr.y);
      var center = {x: isp.x+40, y: isp.y+60};

      var touches = [];
      var touchRange = 0;

      var getTouch = function(id) {
        for (var j = 0; j < touches.length; j++) {
          if (touches[j].t.identifier == id) {
            return touches[j];
          }
        }
        return null;
      }
      var handleMove = function(x, y) {
        var nangle = calcAngle(x,y);
        var adiff = angle - nangle;
        var frac = adiff / Math.PI;
        var m = mid + (frac*30);
        var l = m - spread/2;
        var h = m + spread/2;
        if (m < 15 || m > 35) {
          return;
        }
        drawThermoLines(device.thermoControl, h, l, device.msg.Thermometer.Temp);
      }
      var calcAngle = function(x,y) {
        var esp = svgPoint(maincanvas, x, y);
        var vec = {x: center.x - esp.x, y: center.y - esp.y}
        var angle = Math.atan2(vec.y, vec.x) - Math.atan2(10, 0);
        var twopi = Math.PI * 2;
        if (angle < -Math.PI) {
          angle += Math.PI*2;
        }
        if (angle > Math.PI) {
          angle -= Math.PI*2;
        }
        return angle;
      }
      var sendThermoUpdate = function(m) {
        device.msg.Thermostat.Settings.Low =  m - spread/2;
        device.msg.Thermostat.Settings.High = m + spread/2;
        drawThermoLines(device.thermoControl, device.msg.Thermostat.Settings.High, device.msg.Thermostat.Settings.Low, device.msg.Thermometer.Temp);
        var msg = JSON.stringify({Name: device.name, Climate: {High: m + spread/2, Low: m - spread/2}} );
        ws.send(msg);
        console.log("sent: ", msg);
      }
      device.thermoControl.addEventListener("mousedown", function(e){
        grabbing = 1;
        device.touching = true;
        angle = calcAngle(e.clientX, e.clientY)
        e.preventDefault();
      }, {passive: false})
      window.addEventListener("mousemove", function(e) {
        if (grabbing == 0) {
          return;
        }
        handleMove(e.clientX, e.clientY);
        e.preventDefault();
      })
      var dbgr = document.getElementById("debugger");
      window.addEventListener("mouseup", function(e){
        if (grabbing == 0) {
          return;
        }
        device.touching = false;
        grabbing = 0;
        var nangle = calcAngle(e.clientX, e.clientY)
        var adiff = angle - nangle;
        var frac = adiff / Math.PI;

        m = mid + (frac*30);
        if (m < 15 || m > 35) {
          return;
        }
        sendThermoUpdate(m);
        e.preventDefault();
      }, {passive: false})
      device.thermoControl.addEventListener("touchstart", function(e){
        device.touching = true;
        console.log("TouchStart:", e);
        for (var i = 0; i < e.changedTouches.length; i++) {
            touches.push({
              t: copyTouch(e.changedTouches[i]),
              a: calcAngle(e.changedTouches[i].clientX, e.changedTouches[i].clientY)
            });
        }
        if (touches.length == 1) {
          angle = calcAngle(touches[0].t.clientX, touches[0].t.clientY);
          dbgr.innerText = "one touch: " + angle;
          if (e.cancelable) {
            e.preventDefault();
          }
        }
        if (touches.length == 2) {
          var a = touches[0].t.clientX-touches[1].t.clientX;
          var b = touches[0].t.clientY-touches[1].t.clientY;
          touchRange = a*a + b*b;
          dbgr.innerText = "two touch, d:"+touchRange;
          if (e.cancelable) {
            e.preventDefault();
          }
        }
      }, {passive: false})
      device.thermoControl.addEventListener("touchend", function(e){
        if (touches.length == 0) {
          return;
        }
        var m = mid;
        if (touches.length == 1) {
          var nangle = calcAngle(touches[0].t.clientX, touches[0].t.clientY)
          var adiff = angle - nangle;
          var frac = adiff / Math.PI;
          m = mid + (frac*30);
        }
        console.log("touchend:", e)
        for (var i = 0; i < e.changedTouches.length; i++) {
          var cht = e.changedTouches[i];
          touches = touches.filter(function(v){
            if (v.t.identifier == cht.identifier) {
              if (e.cancelable) {
                e.preventDefault();
              }
              return false;
            }
            return true;
          })
        }
        device.touching = touches.length > 0;
        sendThermoUpdate(m);
        e.preventDefault();
        console.log("device.touching: " + device.touching);
      }, {passive: false})
      device.thermoControl.addEventListener("touchmove", function(e){
        // console.log("TouchMove: ", touches);
        if (touches.length == 0) {
          return;
        }
        for (var i = 0; i < e.changedTouches.length; i++) {
          var chTch = e.changedTouches[i];
          var touch = getTouch(chTch.identifier);
          if (touch != null) {
            touch.t = copyTouch(chTch);
            if (e.cancelable) {
              e.preventDefault();
            }
          }
        }
        if (touches.length == 1) {
          handleMove(touches[0].t.clientX, touches[0].t.clientY);
        } else if (touches.length == 2) {
          var a = touches[0].t.clientX-touches[1].t.clientX;
          var b = touches[0].t.clientY-touches[1].t.clientY;
          var newTouchRange = a*a + b*b;
          var ratio  = newTouchRange / touchRange;
          spread = 10*(ratio/2);
          if (spread > 15) {
            spread = 15;
          } else if (spread < 5) {
            spread = 5;
          }
          dbgr.innerText = "two touch, d:"+touchRange+ "," + newTouchRange + " -- New Spread: " + spread;

          var l = mid - spread/2;
          var h = mid + spread/2;
          drawThermoLines(device.thermoControl, h, l, device.msg.Thermometer.Temp);
        }
      }, {passive: false})
      device.thermoControl.addEventListener("touchcancel", function(e){
        console.log("Cancelled:", e.changedTouches);
      });
    }

    function getRoomPos(left, top) {
      var overEle = document.elementsFromPoint(left, top);
      if (overEle != null) {
        for (var i = 0; i < overEle.length; i++) {
          var p = overEle[i].parentElement;
          if (p == null || p == undefined) {
            continue
          }
          for (var ci = 0; ci < p.classList.length; ci++) {
            if (p.classList[ci] == "room") {
              var pbr = p.parentElement.parentElement.getBoundingClientRect();
              var pp = svgPoint(maincanvas, pbr.x, pbr.y);
              var mp = svgPoint(maincanvas, left, top);
              return {id: p.id, x: Math.floor(mp.x-pp.x), y: Math.floor(mp.y-pp.y)};
            }
          }
        }
      }
      return null;
    }

    function svgPoint(element, x, y) {
      var pt = maincanvas.createSVGPoint();
      pt.x = x;
      pt.y = y;
      return pt.matrixTransform(element.getScreenCTM().inverse());
    }

    function addEditorControls(device) {
      var mousedown = 0;
      var offx = 0;
      var offy = 0;
      var left = 0;
      var top = 0;
      var touching = false;
      var thermoVis = false;

      var highlighted = null;

      // Setup
      var moveControl = function(x, y) {
        var svgp = svgPoint(maincanvas, x, y);
        left = svgp.x-offx;
        top = svgp.y-offy;
        device.itemEle.setAttribute("transform", "translate(" + left + "," + top + ") scale(1.25)")

        var roomPos = getRoomPos(x, y);
        if (roomPos != null) {
          if (highlighted == null || roomPos.id != highlighted.id) {
            if (highlighted != null) {
              highlighted.childNodes[1].setAttribute("fill-opacity", "0.0")
            }
            var item = document.getElementById(roomPos.id);
            if (item != null) {
              item.childNodes[1].setAttribute("fill", "red")
              item.childNodes[1].setAttribute("fill-opacity", "0.3")
              highlighted = item;
            }
          }
        } else {
          if (highlighted != null) {
            highlighted.childNodes[1].setAttribute("fill-opacity", "0.0")
            highlighted = null;
          }
        }
      }
      device.itemEle.addEventListener("mousedown", function(e){
        if (touching || !editing) {
          return;
        }
        mousedown = 1;
        var brect = device.itemEle.getBoundingClientRect();
        var srect = svgPoint(maincanvas, brect.x, brect.y);
        var off = svgPoint(maincanvas, e.clientX, e.clientY);
        console.log("mousedown, off, brect", off, brect, srect);
        offx = off.x-srect.x;
        offy = off.y-srect.y;
        maincanvas.appendChild(device.itemEle);
        device.itemEle.setAttribute("transform", "translate(" + srect.x + "," + srect.y + ")");
        e.preventDefault();
      });
      window.addEventListener("mouseup", function(e){
        if (touching || !editing || mousedown == 0) {
          return;
        }
        var roomPos = getRoomPos(e.clientX, e.clientY);
        if (roomPos != null) {
          // TODO: re-attach to correct floor.
          var msg = JSON.stringify({Name: device.name, Pos: {RoomID: roomPos.id, X: roomPos.x, Y: roomPos.y }});
          ws.send(msg);
          console.log("sent: ", msg);
        }
        mousedown = 0;
      });
      window.addEventListener("mousemove", function(e){
        if (!editing || mousedown == 0 || touching) {
          return;
        }
        // console.log("Mouse move:", e);
        // var off = svgPoint(device.itemEle, e.clientX, e.clientY);
        moveControl(e.clientX, e.clientY);

        e.preventDefault();
      });

      device.itemEle.addEventListener("touchstart", function(e) {
        if (!editing) {
          return;
        }
        touching = true;

        var brect = device.itemEle.getBoundingClientRect();
        var srect = svgPoint(maincanvas, brect.x, brect.y);
        var off = svgPoint(maincanvas, e.touches[0].clientX, e.touches[0].clientY);
        console.log("mousedown, off, brect", off, brect, srect);
        offx = off.x-srect.x;
        offy = off.y-srect.y;
        maincanvas.appendChild(device.itemEle);
        device.itemEle.setAttribute("transform", "translate(" + srect.x + "," + srect.y + ")")
      }, false);
      device.itemEle.addEventListener("touchend", function(e) {
        if (!editing || !touching) {
          return;
        }
        var roomPos = getRoomPos(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        if (roomPos != null) {
          // TODO: re-attach to correct floor.
          var msg = JSON.stringify({Name: device.name, Pos: {RoomID: roomPos.id, X: roomPos.x, Y: roomPos.y }});
          ws.send(msg);
          console.log("sent: ", msg);
        }
        touching = false;
      }, false);
      device.itemEle.addEventListener("touchcancel", function(e) {}, false);
      device.itemEle.addEventListener("touchmove", function(e) {
        if (!editing || !touching) {
          return;
        }
        moveControl(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        e.preventDefault();
      }, false);
    }

    function drawThermoLines(thermoControl, high, low, temp) {
      // var hV = (high+low)/2;
      var hV = high;
      var lV = low;
      if (units == "F") {
        hV = convertToF(hV);
        lV = convertToF(lV);
      }

        var ca = Math.PI/2 - (((high-10)/30) * Math.PI);
        var x = Math.cos(ca);
        var y = Math.sin(ca);
        thermoControl.childNodes[5].setAttribute("d", "M " + (x * 100) + " " + (100+(y*100)) + "L " + (x*50) + " " + (100+(y*50)));
        thermoControl.childNodes[13].textContent = (hV).toFixed(0);
        thermoControl.childNodes[13].setAttribute("x", x*120);
        thermoControl.childNodes[13].setAttribute("y", 100+(y*120));

        var ca = Math.PI/2 - (((low-10)/30) * Math.PI);
        var xl = Math.cos(ca);
        var yl = Math.sin(ca);
        thermoControl.childNodes[7].setAttribute("d", "M " + (xl * 100) + " " + (100+(yl*100)) + "L " + (xl*50) + " " + (100+(yl*50)));
        thermoControl.childNodes[15].textContent = (lV).toFixed(0);
        thermoControl.childNodes[15].setAttribute("x", xl*120);
        thermoControl.childNodes[15].setAttribute("y", 100+(yl*120));

        var ca = Math.PI/2 - (((temp-10)/30) * Math.PI);
        var xt = Math.cos(ca);
        var yt = Math.sin(ca);
        thermoControl.childNodes[9].setAttribute("d", "M " + (xt * 110) + " " + (100+(yt*110)) + "L " + (xt*40) + " " + (100+(yt*40)));
        // Highlighted area
        thermoControl.childNodes[11].setAttribute("d", "M " + x*50 + " " + (100+(y*50)) + " L " + x*100 + " " + (100+(y*100)) + " A 100 100 0 0 1 " + (xl * 100) + " " + (100+(yl*100)) + " L " + (xl*50) + " " + (100+(yl*50)) + " A 50 50 0 0 0 "  + x*50 + " " + (100+(y*50)));
    }

    function toggleUnits() {
      var toggle = document.getElementById("unittoggle");

      if (units == "F") {
        localStorage.setItem("units" , "C");
        toggle.innerText = "Celcius";
        units = "C";
      } else {
        localStorage.setItem("units" , "F");
        toggle.innerText = "Fahrenheit";
        units = "F";
      }
    }

    function getUnits() {
      var lunits = localStorage.getItem("units");
      if (lunits == null) {
        lunits = "C";
      }
      return lunits;
    }

    function convertToF(v) {
      return (v*1.8) + 32;
    }

    function convertToC(v) {
      return (v-32) / 1.8;
    }

    function copyTouch(touch) {
      return { identifier: touch.identifier, clientX: touch.clientX, clientY: touch.clientY };
    }
  </script>
</html>
